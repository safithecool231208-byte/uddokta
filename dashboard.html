<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uddokta | Student Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
    body { background:#f4f7fb; min-height:100vh; padding:20px; color:#2c3e50; }
    .dashboard-container { max-width:1200px; margin:0 auto; }
    .dashboard-header { background:white; border-radius:20px; padding:25px; margin-bottom:25px; box-shadow:0 10px 25px rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; transition:all 0.3s ease; }
    .user-info h1 { font-size:1.8rem; color:#3f51b5; }
    .user-info p { color:#607d8b; }
    .logout-btn { background:#e53935; color:white; border:none; padding:10px 25px; border-radius:10px; font-weight:600; cursor:pointer; transition:0.3s; }
    .logout-btn:hover { background:#b71c1c; }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:20px; margin-bottom:30px; }
    .stat-card { background:white; border-radius:15px; padding:25px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.1); transition:0.3s; }
    .stat-icon { font-size:1.8rem; margin-bottom:8px; }
    .stat-number { font-size:2rem; font-weight:700; }
    .stat-label { color:#555; }
    .blue-card { border-top:5px solid #3f51b5; }
    .green-card { border-top:5px solid #4caf50; }
    .orange-card { border-top:5px solid #ff9800; }
    .purple-card { border-top:5px solid #9c27b0; }
    .section { background:white; border-radius:15px; padding:25px; box-shadow:0 5px 20px rgba(0,0,0,0.1); margin-bottom:30px; transition:all 0.3s; }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
    .section-header h3 { font-size:1.3rem; color:#3f51b5; display:flex; align-items:center; gap:10px; }
    .refresh-btn { background:#4caf50; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; transition:0.3s; display:flex; align-items:center; gap:8px; }
    .refresh-btn:hover { background:#388e3c; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:500; color:#444; }
    .form-group input, .form-group select { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:1rem; transition:0.3s; }
    .submit-btn { background:linear-gradient(135deg,#3f51b5,#9c27b0); color:white; border:none; padding:14px; border-radius:10px; cursor:pointer; font-weight:600; transition:0.3s; grid-column:1/-1; display:flex; align-items:center; justify-content:center; gap:10px; }
    .loading-spinner { width:20px; height:20px; border:2px solid transparent; border-top:2px solid white; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-text { color:#e53935; font-size:0.9rem; margin-top:4px; }
    .success-message { background:#4caf50; color:white; padding:12px 20px; border-radius:10px; margin-bottom:20px; display:none; align-items:center; gap:10px; }
    .table-responsive { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#3f51b5; color:white; }
    tr:hover { background:#f1f8ff; }
    .status-badge { padding:5px 10px; border-radius:15px; font-weight:600; }
    .paid { background:#c8e6c9; color:#2e7d32; }
    .pending { background:#ffe0b2; color:#ef6c00; }
    #searchInput { margin-bottom:15px; padding:10px; width:100%; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    @media(max-width:768px){ .dashboard-header{ flex-direction:column; text-align:center; } .form-grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="user-info">
        <h1>Welcome, <span id="userName">User</span> ðŸ‘‹</h1>
        <p>Member ID: <strong id="userMemberId">Loading...</strong></p>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card blue-card">
        <div class="stat-icon"><i class="fas fa-list"></i></div>
        <div class="stat-number" id="totalPayments">0</div>
        <div class="stat-label">Total Payments</div>
      </div>
      <div class="stat-card green-card">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-number" id="paidPayments">0</div>
        <div class="stat-label">Paid Payments</div>
      </div>
      <div class="stat-card orange-card">
        <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
        <div class="stat-number" id="pendingPayments">0</div>
        <div class="stat-label">Pending Payments</div>
      </div>
      <div class="stat-card purple-card">
        <div class="stat-icon"><i class="fas fa-wallet"></i></div>
        <div class="stat-number" id="totalAmount">0</div>
        <div class="stat-label">Total Paid Amount (Tk)</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><h3><i class="fas fa-plus-circle"></i> Submit New Payment</h3></div>
      <div class="success-message" id="successMessage"><i class="fas fa-check-circle"></i> <span id="successText">Payment submitted successfully!</span></div>

      <form id="paymentForm" class="form-grid">
        <div class="form-group"><label>Month & Year *</label><input type="month" name="Month" required></div>
        <div class="form-group"><label>Payment Date *</label><input type="date" name="PaymentDate" required></div>
        <div class="form-group"><label>Amount *</label><input type="number" name="Amount" placeholder="Enter Amount" required></div>
        <div class="form-group">
          <label>Payment Method *</label>
          <select name="Method" id="paymentMethod" required>
            <option value="">Select Method</option>
            <option>Bkash</option>
            <option>Nagad</option>
            <option>Bank</option>
            <option>Cash</option>
          </select>
        </div>
        <div class="form-group"><label>Phone Number *</label><input type="text" name="Phone" placeholder="Enter Phone Number" required></div>
        <div class="form-group"><label>Transaction ID *</label><input type="text" name="TrxID" id="trxInput" placeholder="Enter TrxID" required><div class="error-text" id="trxError"></div></div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <span class="btn-text"><i class="fas fa-paper-plane"></i> Submit Payment</span>
          <span class="btn-loading" style="display:none;"><div class="loading-spinner"></div> Processing...</span>
        </button>
      </form>
    </div>

    <div class="section">
      <div class="section-header">
        <h3><i class="fas fa-history"></i> Payment History</h3>
        <button class="refresh-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>

      <input type="text" id="searchInput" placeholder="Search by TrxID, Number, or Payment Date...">
      <div class="table-responsive">
        <table id="paymentTable">
          <thead>
            <tr>
              <th>Month</th>
              <th>Amount</th>
              <th>Status</th>
              <th>TrxID</th>
              <th>Number</th>
              <th>Payment Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzOV_6qryGz6vJwkc386R8CjrPyFLAvNGC6kItTN9jrPVTOK_D6265m8msP24CoYEmU/exec";
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
let paymentsCache = [];
let existingTrxIDs = [];

const submitBtn = document.getElementById("submitBtn");
const refreshBtn = document.getElementById("refreshBtn");
const paymentMethodSelect = document.getElementById("paymentMethod");
const trxInput = document.getElementById("trxInput");
const trxError = document.getElementById("trxError");
const searchInput = document.getElementById("searchInput");
const successMessage = document.getElementById("successMessage");

function field(obj, key) {
  if (!obj) return undefined;
  if (key in obj) return obj[key];
  const found = Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase());
  return found ? obj[found] : undefined;
}
function safeString(v){ return v === undefined || v === null ? "" : String(v); }
function toSearchString(v){ return safeString(v).toLowerCase(); }
function parseDate(v){
  if(!v) return null;
  const d = new Date(v);
  if(!isNaN(d.getTime())) return d;
  const n = Date.parse(v);
  return isNaN(n) ? null : new Date(n);
}

paymentMethodSelect.addEventListener("change", ()=>{
  if(paymentMethodSelect.value === "Cash"){
    trxInput.value = "";
    trxInput.disabled = true;
    trxInput.removeAttribute("required");
    trxInput.placeholder = "Not required for Cash";
    trxError.textContent = "";
  } else {
    trxInput.disabled = false;
    trxInput.setAttribute("required","true");
    trxInput.placeholder = "Enter TrxID";
  }
});

window.addEventListener("load", ()=>{
  if(!currentUser || (!currentUser.memberId && !currentUser.email)) {
    location.href = "index.html";
    return;
  }
  document.getElementById("userName").textContent = currentUser.fullName || "User";
  document.getElementById("userMemberId").textContent = currentUser.memberId || currentUser.email || "Unknown";
  loadPayments();
});

async function loadPayments(){
  const tbody = document.querySelector("#paymentTable tbody");
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center"><div class="loading-spinner" style="display:inline-block;margin:8px 0"></div> Loading payments...</td></tr>`;
  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: new URLSearchParams({ action: "get_payments", memberId: currentUser.memberId || currentUser.email })
    });
    const json = await res.json();
    if(json && json.result === "success"){
      paymentsCache = Array.isArray(json.payments) ? json.payments : [];
      existingTrxIDs = paymentsCache.map(p => toSearchString(field(p, "TrxID") || field(p, "trxid") || ""));
      renderTable(paymentsCache);
      updateStats(paymentsCache);
    } else {
      tbody.innerHTML = `<tr><td colspan="6">Error loading payments: ${json && json.message ? json.message : "unknown"}</td></tr>`;
      paymentsCache = [];
      existingTrxIDs = [];
    }
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6">Network error while loading payments</td></tr>`;
    paymentsCache = [];
    existingTrxIDs = [];
  }
}

function renderTable(payments){
  const tbody = document.querySelector("#paymentTable tbody");
  if(!payments || payments.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6">No payments found</td></tr>`;
    return;
  }
  const sorted = payments.slice().sort((a,b)=>{
    const da = parseDate(field(a,"PaymentDate") || field(a,"date"));
    const db = parseDate(field(b,"PaymentDate") || field(b,"date"));
    if(!da && !db) return 0;
    if(!da) return 1;
    if(!db) return -1;
    return db - da;
  });

  tbody.innerHTML = sorted.map(p=>{
    const month = safeString(field(p,"Month") || field(p,"month"));
    const amount = safeString(field(p,"Amount") || field(p,"amount"));
    const statusRaw = safeString(field(p,"Status") || field(p,"status"));
    const status = statusRaw || "";
    const trx = safeString(field(p,"TrxID") || field(p,"trxid"));
    const phone = safeString(field(p,"Phone") || field(p,"Number") || "");
    const pdRaw = field(p,"PaymentDate") || field(p,"date") || "";
    const d = parseDate(pdRaw);
    const paymentDate = d ? d.toLocaleDateString() : safeString(pdRaw);

    const cls = status.toLowerCase() === "paid" ? "paid" : "pending";

    return `<tr>
      <td>${escapeHtml(month)}</td>
      <td>${escapeHtml(amount)} Tk</td>
      <td><span class="status-badge ${cls}">${escapeHtml(status)}</span></td>
      <td>${escapeHtml(trx)}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(paymentDate)}</td>
    </tr>`;
  }).join("");
}

function escapeHtml(s){ return s === null || s === undefined ? "" : String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

function updateStats(payments){
  const total = payments.length;
  const paid = payments.filter(p => toSearchString(field(p,"Status") || field(p,"status")) === "paid").length;
  const pending = payments.filter(p => toSearchString(field(p,"Status") || field(p,"status")) === "pending").length;
  const totalAmount = payments.reduce((sum,p) => sum + (parseFloat(field(p,"Amount") || field(p,"amount") || 0) || 0), 0);

  document.getElementById("totalPayments").textContent = total;
  document.getElementById("paidPayments").textContent = paid;
  document.getElementById("pendingPayments").textContent = pending;
  document.getElementById("totalAmount").textContent = totalAmount + " Tk";
}

searchInput.addEventListener("input", ()=>{
  const term = searchInput.value.trim().toLowerCase();
  if(!term) { renderTable(paymentsCache); return; }

  const filtered = paymentsCache.filter(p=>{
    const trx = toSearchString(field(p,"TrxID") || field(p,"trxid"));
    const phone = toSearchString(field(p,"Phone") || field(p,"Number"));
    const pdRaw = field(p,"PaymentDate") || field(p,"date") || "";
    const d = parseDate(pdRaw);
    const dateFormatted = d ? d.toLocaleDateString() : safeString(pdRaw);
    return trx.includes(term) || phone.includes(term) || dateFormatted.toLowerCase().includes(term);
  });

  renderTable(filtered);
});

document.getElementById("paymentForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  trxError.textContent = "";

  const form = e.target;
  const fd = new FormData(form);
  const method = fd.get("Method");
  let trxValue = method === "Cash"
