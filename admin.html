<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Uddokta â€” Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#3b82f6;
  --bg2:#7c3aed;
  --card:rgba(255,255,255,0.92);
  --muted:#64748b;
  --paid:#16a34a;
  --pending:#f59e0b;
  --danger:#ef4444;
  --radius:14px;
  --shadow:0 10px 30px rgba(2,6,23,0.12);
}
*{box-sizing:border-box;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial}
html,body{margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:1150px;margin:28px auto;padding:20px}
.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
h2,h3{margin:0 0 10px}
button{cursor:pointer}
.btn{background:linear-gradient(90deg,var(--bg1),var(--bg2));color:#fff;padding:10px 14px;border:none;border-radius:10px;font-weight:600;transition:transform .15s ease}
.btn:hover{transform:translateY(-3px)}
.btn.secondary{background:white;color:var(--bg2);border:1px solid #ddd}
.searchbar{display:flex;gap:8px;align-items:center;margin-top:10px}
.searchbar input{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd}
.table-wrap{margin-top:10px;overflow:auto;background:white;border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:900px}
th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
th{background:var(--bg2);color:white;position:sticky;top:0}
.badge-paid{background:rgba(22,163,74,0.12);color:var(--paid);padding:6px 10px;border-radius:12px;font-weight:700}
.badge-pending{background:rgba(245,158,11,0.12);color:var(--pending);padding:6px 10px;border-radius:12px;font-weight:700}
.topbar{display:flex;justify-content:space-between;align-items:center;color:white;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.msg{padding:10px;border-radius:10px;margin-top:10px;text-align:center;display:none}
.msg.success{background:linear-gradient(90deg,#16a34a,#059669);color:white}
.msg.error{background:linear-gradient(90deg,#ef4444,#dc2626);color:white}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div>
      <h2>Admin Panel</h2>
      <div class="small">View and update all member payments</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="refreshBtn" class="btn secondary">Refresh</button>
      <button id="exportBtn" class="btn secondary">Export JSON</button>
      <button id="backBtn" class="btn">Back to Dashboard</button>
    </div>
  </div>

  <div class="card">
    <div class="searchbar">
      <input id="searchAdmin" placeholder="Search by Email, Name, Number, Date, TrxID" oninput="filterAdmin()">
    </div>

    <div class="msg" id="adminMsg"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Email</th><th>Name</th><th>Month</th><th>Amount</th>
            <th>Status</th><th>TrxID</th><th>Number</th><th>Date</th>
            <th>Method</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbypMtu8q9NayvGiRNWazRAkG0bnuHeC5EMf19IpYfT4HoVmy9ffOc8sTJuHEVpamqvN/exec";

function el(id){return document.getElementById(id);}
function toast(text,type='success'){
  const msg=el('adminMsg');
  msg.textContent=text;
  msg.className='msg '+(type==='success'?'success':'error');
  msg.style.display='block';
  setTimeout(()=>msg.style.display='none',4000);
}

/* === Load all payments === */
async function loadAllPayments(){
  const fd=new FormData();fd.append('action','get_all_payments');
  try{
    const res=await fetch(SCRIPT_URL,{method:'POST',body:fd});
    const d=await res.json();
    if(d.result==='success')renderTable(d.payments||[]);
    else toast(d.message||'Load failed','error');
  }catch(e){toast('Network error','error');}
}

/* === Render table === */
function renderTable(list){
  const tb=el('adminTable');tb.innerHTML='';
  if(!list.length){tb.innerHTML='<tr><td colspan="10" style="text-align:center;color:#666">No data found</td></tr>';return;}
  list.slice().sort((a,b)=>new Date(b.PaymentDate||0)-new Date(a.PaymentDate||0)).forEach(p=>{
    const status=p.Status||'Pending';
    const cls=status==='Paid'?'badge-paid':'badge-pending';
    tb.innerHTML+=`<tr>
      <td>${p.Email||''}</td><td>${p.Name||''}</td><td>${p.Month||''}</td>
      <td>${p.Amount||''}</td>
      <td><span class="${cls}">${status}</span></td>
      <td>${p.TrxID||''}</td><td>${p.Number||''}</td><td>${p.PaymentDate||''}</td>
      <td>${p.Method||''}</td>
      <td>${status==='Paid'
        ?'<span style="color:var(--paid);font-weight:600">Paid</span>'
        :`<button class="btn secondary" onclick="markPaid('${p.TrxID||''}')">Mark Paid</button>`}</td>
      </tr>`;
  });
}

/* === Mark as paid === */
async function markPaid(trx){
  if(!trx)return;
  if(!confirm(`Mark ${trx} as Paid?`))return;
  const fd=new FormData();fd.append('action','update_status');fd.append('TrxID',trx);fd.append('Status','Paid');
  try{
    const res=await fetch(SCRIPT_URL,{method:'POST',body:fd});
    const j=await res.json();
    if(j.result==='success'){toast(j.message||'Updated','success');loadAllPayments();}
    else toast(j.message||'Update failed','error');
  }catch(e){toast('Network error','error');}
}

/* === Search filter === */
function filterAdmin(){
  const q=el('searchAdmin').value.toLowerCase();
  document.querySelectorAll('#adminTable tr').forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(q)?'':'none';
  });
}

/* === Export JSON === */
el('exportBtn').addEventListener('click',()=>{
  const rows=Array.from(document.querySelectorAll('#adminTable tr')).map(r=>{
    const c=Array.from(r.children).map(x=>x.textContent.trim());
    return{Email:c[0],Name:c[1],Month:c[2],Amount:c[3],Status:c[4],TrxID:c[5],Number:c[6],Date:c[7],Method:c[8]};
  });
  const blob=new Blob([JSON.stringify(rows,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='payments.json';a.click();
});

/* === Back / Refresh === */
el('refreshBtn').addEventListener('click',loadAllPayments);
el('backBtn').addEventListener('click',()=>window.location.href='dashboard.html');

/* === Boot === */
loadAllPayments();
</script>
</body>
</html>
